# DarkWin Penetration Testing Automation
# Author: viphacker.100
# Description: Automates penetration testing tools and workflows

#Requires -RunAsAdministrator

$ErrorActionPreference = "Stop"
$LogFile = "C:\Tools\Logs\pentest_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
$ReportDir = "C:\Tools\Reports\Pentest\$(Get-Date -Format 'yyyyMMdd_HHmmss')"

function Write-Log {
    param($Message)
    $LogMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'): $Message"
    Add-Content -Path $LogFile -Value $LogMessage
    Write-Host $LogMessage
}

function Initialize-Pentest {
    param(
        [string]$Target,
        [string]$Scope
    )
    Write-Log "Initializing penetration test for $Target..."
    
    # Create report directory
    New-Item -ItemType Directory -Path $ReportDir -Force | Out-Null
    
    # Create test workspace
    $Workspace = @{
        "target" = $Target
        "scope" = $Scope
        "start_time" = Get-Date
        "tools" = @()
        "findings" = @()
    }
    
    $Workspace | ConvertTo-Json | Out-File "$ReportDir\workspace.json"
    Write-Log "Pentest workspace created: $ReportDir"
}

function Start-Reconnaissance {
    param(
        [string]$Target,
        [string]$OutputFile
    )
    Write-Log "Starting reconnaissance phase..."
    
    # Nmap scan
    $NmapArgs = "-sV -sC -O --script vuln -oA `"$OutputFile`" $Target"
    nmap $NmapArgs
    
    # DNS enumeration
    $DnsTools = @(
        "nslookup",
        "dig",
        "host"
    )
    
    foreach ($Tool in $DnsTools) {
        & $Tool $Target | Out-File "$OutputFile.dns.txt" -Append
    }
    
    # WHOIS lookup
    whois $Target | Out-File "$OutputFile.whois.txt"
    
    Write-Log "Reconnaissance completed"
}

function Start-WebScan {
    param(
        [string]$Target,
        [string]$OutputFile
    )
    Write-Log "Starting web application scan..."
    
    # Nikto scan
    nikto -h $Target -o "$OutputFile.nikto.txt"
    
    # SQLMap scan
    sqlmap -u $Target --batch --random-agent --output-dir="$OutputFile.sqlmap"
    
    # Dirb scan
    dirb http://$Target -o "$OutputFile.dirb.txt"
    
    # Gobuster scan
    gobuster dir -u http://$Target -w "C:\Tools\Wordlists\SecLists\Discovery\Web-Content\common.txt" -o "$OutputFile.gobuster.txt"
    
    Write-Log "Web scan completed"
}

function Start-Exploitation {
    param(
        [string]$Target,
        [string]$OutputFile
    )
    Write-Log "Starting exploitation phase..."
    
    # Metasploit automation
    $MSFCommands = @"
use auxiliary/scanner/portscan/tcp
set RHOSTS $Target
run
use auxiliary/scanner/smb/smb_version
set RHOSTS $Target
run
use auxiliary/scanner/ssh/ssh_version
set RHOSTS $Target
run
"@
    $MSFCommands | Out-File "$OutputFile.msf.rc"
    msfconsole -r "$OutputFile.msf.rc" -o "$OutputFile.msf.txt"
    
    # PowerSploit modules
    $PowerSploitModules = @(
        "Invoke-PortScan",
        "Invoke-UserHunter",
        "Invoke-ShareFinder"
    )
    
    foreach ($Module in $PowerSploitModules) {
        Import-Module "C:\Tools\PowerSploit\Recon\$Module.ps1"
        & $Module -ComputerName $Target | Out-File "$OutputFile.powersploit.txt" -Append
    }
    
    Write-Log "Exploitation completed"
}

function Start-PostExploitation {
    param(
        [string]$Target,
        [string]$OutputFile
    )
    Write-Log "Starting post-exploitation phase..."
    
    # Mimikatz
    if (Test-Path "C:\Tools\Additional\mimikatz\mimikatz.exe") {
        & "C:\Tools\Additional\mimikatz\mimikatz.exe" "privilege::debug" "sekurlsa::logonpasswords" "exit" | Out-File "$OutputFile.mimikatz.txt"
    }
    
    # BloodHound
    if (Test-Path "C:\Tools\Additional\BloodHound\BloodHound.exe") {
        & "C:\Tools\Additional\BloodHound\BloodHound.exe" -c All -d $Target | Out-File "$OutputFile.bloodhound.txt"
    }
    
    # CrackMapExec
    if (Test-Path "C:\Tools\Additional\CrackMapExec\cme.exe") {
        & "C:\Tools\Additional\CrackMapExec\cme.exe" smb $Target --shares | Out-File "$OutputFile.crackmapexec.txt"
    }
    
    Write-Log "Post-exploitation completed"
}

function Generate-Report {
    param(
        [string]$ScanDir
    )
    Write-Log "Generating penetration test report..."
    
    $ReportFile = "$ScanDir\report.html"
    $ReportContent = @"
<!DOCTYPE html>
<html>
<head>
    <title>DarkWin Penetration Test Report</title>
    <style>
        body { font-family: 'Consolas', monospace; margin: 20px; background: #1a1a1a; color: #00ff00; }
        h1, h2, h3 { color: #00ff00; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #333; }
        .finding { margin: 10px 0; padding: 5px; background: #2a2a2a; }
        .critical { color: #ff0000; }
        .high { color: #ff6600; }
        .medium { color: #ffff00; }
        .low { color: #00ff00; }
        pre { background: #2a2a2a; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>DarkWin Penetration Test Report</h1>
    <div class="section">
        <h2>Test Information</h2>
        <p>Date: $(Get-Date)</p>
        <p>Target: $($Workspace.target)</p>
        <p>Scope: $($Workspace.scope)</p>
    </div>
"@
    
    # Add findings from each phase
    $ReportContent += @"
    <div class="section">
        <h2>Findings</h2>
"@
    
    # Add findings from scan files
    Get-ChildItem -Path $ScanDir -Filter "*.txt" | ForEach-Object {
        $ReportContent += @"
        <div class="finding">
            <h3>$($_.Name)</h3>
            <pre>$(Get-Content $_.FullName -Raw)</pre>
        </div>
"@
    }
    
    $ReportContent += @"
    </div>
</body>
</html>
"@
    
    $ReportContent | Out-File $ReportFile
    Write-Log "Report generated: $ReportFile"
}

# Main execution
try {
    param(
        [Parameter(Mandatory=$true)]
        [string]$Target,
        
        [Parameter(Mandatory=$true)]
        [string]$Scope
    )
    
    Initialize-Pentest -Target $Target -Scope $Scope
    
    # Run penetration test phases
    Start-Reconnaissance -Target $Target -OutputFile "$ReportDir\recon"
    Start-WebScan -Target $Target -OutputFile "$ReportDir\web"
    Start-Exploitation -Target $Target -OutputFile "$ReportDir\exploit"
    Start-PostExploitation -Target $Target -OutputFile "$ReportDir\post"
    
    # Generate report
    Generate-Report -ScanDir $ReportDir
    
    Write-Log "Penetration test completed successfully"
} catch {
    Write-Log "ERROR: Penetration test failed - $_"
    exit 1
} 