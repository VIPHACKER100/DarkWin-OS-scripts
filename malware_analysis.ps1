# DarkWin Malware Analysis
# Author: viphacker.100
# Description: Performs malware analysis and reverse engineering

#Requires -RunAsAdministrator

$ErrorActionPreference = "Stop"
$LogFile = "C:\Tools\Logs\malware_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
$AnalysisDir = "C:\Tools\Analysis\$(Get-Date -Format 'yyyyMMdd_HHmmss')"

function Write-Log {
    param($Message)
    $LogMessage = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'): $Message"
    Add-Content -Path $LogFile -Value $LogMessage
    Write-Host $LogMessage
}

function Initialize-Analysis {
    param(
        [string]$SamplePath
    )
    Write-Log "Initializing malware analysis..."
    
    # Create analysis directory
    New-Item -ItemType Directory -Path $AnalysisDir -Force | Out-Null
    
    # Create analysis workspace
    $Workspace = @{
        "sample_path" = $SamplePath
        "sample_hash" = (Get-FileHash $SamplePath -Algorithm SHA256).Hash
        "start_time" = Get-Date
        "tools" = @()
        "findings" = @()
    }
    
    $Workspace | ConvertTo-Json | Out-File "$AnalysisDir\workspace.json"
    Write-Log "Analysis workspace created: $AnalysisDir"
}

function Start-StaticAnalysis {
    param(
        [string]$SamplePath
    )
    Write-Log "Starting static analysis..."
    
    # Calculate file hashes
    $Hashes = @{
        "MD5" = (Get-FileHash $SamplePath -Algorithm MD5).Hash
        "SHA1" = (Get-FileHash $SamplePath -Algorithm SHA1).Hash
        "SHA256" = (Get-FileHash $SamplePath -Algorithm SHA256).Hash
    }
    $Hashes | ConvertTo-Json | Out-File "$AnalysisDir\file_hashes.json"
    
    # Analyze with PEiD
    if (Test-Path "C:\Tools\Additional\PEiD\PEiD.exe") {
        & "C:\Tools\Additional\PEiD\PEiD.exe" $SamplePath | Out-File "$AnalysisDir\peid.txt"
    }
    
    # Analyze with Detect It Easy
    if (Test-Path "C:\Tools\Additional\DIE\die.exe") {
        & "C:\Tools\Additional\DIE\die.exe" $SamplePath | Out-File "$AnalysisDir\die.txt"
    }
    
    # Analyze with YARA
    if (Test-Path "C:\Tools\Additional\YARA\yara.exe") {
        & "C:\Tools\Additional\YARA\yara.exe" -r "C:\Tools\Rules\yara" $SamplePath | Out-File "$AnalysisDir\yara.txt"
    }
    
    Write-Log "Static analysis completed"
}

function Start-DynamicAnalysis {
    param(
        [string]$SamplePath
    )
    Write-Log "Starting dynamic analysis..."
    
    # Analyze with Process Monitor
    if (Test-Path "C:\Tools\Additional\ProcessMonitor\Procmon.exe") {
        Start-Process "C:\Tools\Additional\ProcessMonitor\Procmon.exe" -ArgumentList "/BackingFile `"$AnalysisDir\procmon.pml`""
        Start-Sleep -Seconds 5
        & "C:\Tools\Additional\ProcessMonitor\Procmon.exe" /Terminate
    }
    
    # Analyze with Process Explorer
    if (Test-Path "C:\Tools\Additional\ProcessExplorer\procexp.exe") {
        Start-Process "C:\Tools\Additional\ProcessExplorer\procexp.exe" -ArgumentList "/accepteula"
    }
    
    # Analyze with API Monitor
    if (Test-Path "C:\Tools\Additional\APIMonitor\apimonitor.exe") {
        & "C:\Tools\Additional\APIMonitor\apimonitor.exe" $SamplePath | Out-File "$AnalysisDir\apimonitor.txt"
    }
    
    Write-Log "Dynamic analysis completed"
}

function Start-NetworkAnalysis {
    param(
        [string]$SamplePath
    )
    Write-Log "Starting network analysis..."
    
    # Start Wireshark capture
    if (Test-Path "C:\Program Files\Wireshark\Wireshark.exe") {
        Start-Process "C:\Program Files\Wireshark\Wireshark.exe" -ArgumentList "-k -i any -w `"$AnalysisDir\network.pcap`""
    }
    
    # Start Fiddler
    if (Test-Path "C:\Tools\Additional\Fiddler\Fiddler.exe") {
        Start-Process "C:\Tools\Additional\Fiddler\Fiddler.exe"
    }
    
    # Execute sample in sandbox
    Start-Process $SamplePath
    
    # Wait for analysis
    Start-Sleep -Seconds 30
    
    # Stop captures
    if (Test-Path "C:\Program Files\Wireshark\Wireshark.exe") {
        Stop-Process -Name "Wireshark" -Force
    }
    if (Test-Path "C:\Tools\Additional\Fiddler\Fiddler.exe") {
        Stop-Process -Name "Fiddler" -Force
    }
    
    Write-Log "Network analysis completed"
}

function Start-MemoryAnalysis {
    param(
        [string]$SamplePath
    )
    Write-Log "Starting memory analysis..."
    
    # Create memory dump
    if (Test-Path "C:\Tools\Additional\WinPMem\winpmem.exe") {
        & "C:\Tools\Additional\WinPMem\winpmem.exe" "$AnalysisDir\memory.aff4"
    }
    
    # Analyze with Volatility
    if (Test-Path "C:\Tools\Additional\Volatility\volatility.exe") {
        $VolatilityArgs = @(
            "-f `"$AnalysisDir\memory.aff4`"",
            "imageinfo",
            "pslist",
            "pstree",
            "dlllist",
            "handles",
            "malfind",
            "svcscan",
            "netscan"
        )
        
        foreach ($Arg in $VolatilityArgs) {
            & "C:\Tools\Additional\Volatility\volatility.exe" $Arg | Out-File "$AnalysisDir\volatility_$($Arg.Split()[0]).txt"
        }
    }
    
    Write-Log "Memory analysis completed"
}

function Start-ReverseEngineering {
    param(
        [string]$SamplePath
    )
    Write-Log "Starting reverse engineering..."
    
    # Analyze with IDA Pro
    if (Test-Path "C:\Tools\Additional\IDA\ida64.exe") {
        Start-Process "C:\Tools\Additional\IDA\ida64.exe" -ArgumentList "-A -S`"C:\Tools\Scripts\ida_analysis.py`" `"$SamplePath`""
    }
    
    # Analyze with Ghidra
    if (Test-Path "C:\Tools\Additional\Ghidra\ghidraRun.bat") {
        Start-Process "C:\Tools\Additional\Ghidra\ghidraRun.bat" -ArgumentList "`"$SamplePath`""
    }
    
    # Analyze with x64dbg
    if (Test-Path "C:\Tools\Additional\x64dbg\x64\x64dbg.exe") {
        Start-Process "C:\Tools\Additional\x64dbg\x64\x64dbg.exe" -ArgumentList "`"$SamplePath`""
    }
    
    Write-Log "Reverse engineering completed"
}

function Generate-AnalysisReport {
    param(
        [string]$AnalysisDir
    )
    Write-Log "Generating malware analysis report..."
    
    $ReportFile = "$AnalysisDir\report.html"
    $ReportContent = @"
<!DOCTYPE html>
<html>
<head>
    <title>DarkWin Malware Analysis Report</title>
    <style>
        body { font-family: 'Consolas', monospace; margin: 20px; background: #1a1a1a; color: #00ff00; }
        h1, h2, h3 { color: #00ff00; }
        .section { margin: 20px 0; padding: 10px; border: 1px solid #333; }
        .finding { margin: 10px 0; padding: 5px; background: #2a2a2a; }
        .critical { color: #ff0000; }
        .warning { color: #ffff00; }
        .info { color: #00ff00; }
        pre { background: #2a2a2a; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>DarkWin Malware Analysis Report</h1>
    <div class="section">
        <h2>Sample Information</h2>
        <p>Date: $(Get-Date)</p>
        <p>Analysis Directory: $AnalysisDir</p>
    </div>
"@
    
    # Add analysis results
    $ReportContent += @"
    <div class="section">
        <h2>Analysis Results</h2>
"@
    
    # Add analysis files
    Get-ChildItem -Path $AnalysisDir -Filter "*.txt" | ForEach-Object {
        $ReportContent += @"
        <div class="finding">
            <h3>$($_.Name)</h3>
            <pre>$(Get-Content $_.FullName -Raw)</pre>
        </div>
"@
    }
    
    $ReportContent += @"
    </div>
</body>
</html>
"@
    
    $ReportContent | Out-File $ReportFile
    Write-Log "Report generated: $ReportFile"
}

# Main execution
try {
    param(
        [Parameter(Mandatory=$true)]
        [string]$SamplePath
    )
    
    Initialize-Analysis -SamplePath $SamplePath
    
    # Run analysis phases
    Start-StaticAnalysis -SamplePath $SamplePath
    Start-DynamicAnalysis -SamplePath $SamplePath
    Start-NetworkAnalysis -SamplePath $SamplePath
    Start-MemoryAnalysis -SamplePath $SamplePath
    Start-ReverseEngineering -SamplePath $SamplePath
    
    # Generate report
    Generate-AnalysisReport -AnalysisDir $AnalysisDir
    
    Write-Log "Malware analysis completed successfully"
} catch {
    Write-Log "ERROR: Malware analysis failed - $_"
    exit 1
} 